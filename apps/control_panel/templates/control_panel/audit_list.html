{% extends 'control_panel/base.html' %}
{% load control_panel_extras %}

{% block control_content %}
<div class="console-main-header">
    <div>
        <div class="console-main-title">{{ title }}</div>
        <div class="console-main-meta">Всего записей: {{ page_obj.paginator.count }}</div>
    </div>
    <div class="console-header-actions">
        <form method="get" action="" class="console-search-form">
            <input type="search" name="q" value="{{ search_q }}" placeholder="Поиск..." class="console-search-input" aria-label="Поиск">
            <button type="submit" class="btn-xs">Найти</button>
        </form>
        <span class="console-badge-readonly">read only</span>
    </div>
</div>
<div class="console-table-wrap">
    <table class="console-table">
        <thead>
            <tr>
                <th>#</th>
                <th>action</th>
                <th>table_name</th>
                <th title="Идентификатор изменённой записи в таблице">record_id (ID записи)</th>
                <th>old_values</th>
                <th>new_values</th>
                <th>changed_fields</th>
                <th>performed_by</th>
                <th>performed_at</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.pk }}</td>
                <td>{{ item.action }}</td>
                <td>{{ item.table_name }}</td>
                <td>{{ item.record_id }}</td>
                <td><div class="audit-json-scroll audit-json-expand" tabindex="0" role="button" data-label="old_values" title="Нажмите для просмотра полностью"><pre class="audit-json">{{ item.old_values|json_dump|default:"—" }}</pre></div></td>
                <td><div class="audit-json-scroll audit-json-expand" tabindex="0" role="button" data-label="new_values" title="Нажмите для просмотра полностью"><pre class="audit-json">{{ item.new_values|json_dump|default:"—" }}</pre></div></td>
                <td>{% if item.changed_fields %}{{ item.changed_fields|join:", " }}{% else %}—{% endif %}</td>
                <td>{{ item.performed_by|default:"—" }}</td>
                <td>{{ item.performed_at|date:"d.m.Y H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="9">
                    <div class="console-table-empty">Записей нет</div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if page_obj.has_other_pages %}
<nav class="console-pagination" aria-label="Пагинация">
    <div class="console-pagination-inner">
        {% if page_obj.has_previous %}
        <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn-pagination" aria-label="Предыдущая">← Назад</a>
        {% else %}
        <span class="btn-pagination btn-pagination-disabled" aria-disabled="true">← Назад</span>
        {% endif %}
        <div class="console-pagination-pages">
            {% for p in page_obj.paginator.page_range %}
                {% if p == page_obj.number %}
                <span class="btn-pagination btn-pagination-active" aria-current="page">{{ p }}</span>
                {% else %}
                <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ p }}" class="btn-pagination">{{ p }}</a>
                {% endif %}
            {% endfor %}
        </div>
        {% if page_obj.has_next %}
        <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn-pagination" aria-label="Следующая">Вперёд →</a>
        {% else %}
        <span class="btn-pagination btn-pagination-disabled" aria-disabled="true">Вперёд →</span>
        {% endif %}
    </div>
</nav>
{% endif %}

<div id="audit-json-modal" class="audit-json-modal" aria-hidden="true">
    <div class="audit-json-modal-backdrop"></div>
    <div class="audit-json-modal-box">
        <div class="audit-json-modal-header">
            <span id="audit-json-modal-title">JSON</span>
            <button type="button" class="audit-json-modal-close" aria-label="Закрыть">&times;</button>
        </div>
        <pre id="audit-json-modal-content" class="audit-json-modal-content"></pre>
    </div>
</div>

<script>
(function() {
    var modal = document.getElementById('audit-json-modal');
    var content = document.getElementById('audit-json-modal-content');
    var title = document.getElementById('audit-json-modal-title');
    var closeBtn = modal && modal.querySelector('.audit-json-modal-close');
    var backdrop = modal && modal.querySelector('.audit-json-modal-backdrop');

    function openModal(el) {
        if (!modal || !content) return;
        var pre = el && el.querySelector('.audit-json');
        var label = el && el.getAttribute('data-label');
        content.textContent = pre ? pre.textContent : '';
        title.textContent = label || 'JSON';
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        if (!modal) return;
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }

    document.addEventListener('click', function(e) {
        var expand = e.target.closest('.audit-json-expand');
        if (expand) {
            e.preventDefault();
            openModal(expand);
        }
        if (e.target === backdrop || e.target === closeBtn) {
            closeModal();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
            closeModal();
        }
    });
})();
</script>
{% endblock %}
