name: LeaseGrow CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  DJANGO_SETTINGS_MODULE: config.settings.local
  DB_NAME: test_leasegrow
  DB_USER: postgres
  DB_PASSWORD: postgres
  DB_HOST: localhost
  DB_PORT: 5432
  SECRET_KEY: test-secret-key-for-ci

jobs:
  build:
    name: Build Django project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          cp .env.example .env 2>/dev/null || true

      - name: Django check
        run: |
          python manage.py check

  linter:
    name: Lint with flake8
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt flake8

      - name: Run flake8
        continue-on-error: true
        run: |
          flake8 apps/ config/ manage.py --max-line-length=120

  analyze:
    name: Radon + Bandit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt radon bandit

      - name: Radon complexity
        continue-on-error: true
        run: |
          radon cc apps/ config/ -a

      - name: Bandit security
        continue-on-error: true
        run: |
          bandit -r apps/ config/ -ll

  test:
    name: Run tests
    runs-on: ubuntu-latest
    needs: build
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_DB: test_leasegrow
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready -U postgres
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Prepare env
        run: |
          cp .env.example .env 2>/dev/null || true
          echo "SECRET_KEY=test-ci-secret-key" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_NAME=test_leasegrow" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=postgres" >> .env

      - name: Run tests
        run: |
          python manage.py test tests -v 2
