{% extends 'core/base.html' %}
{% load static %}

{% block title %}Заявки на ТО — LeaseGrow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'control_panel/css/control_panel.css' %}">
<style>
.chat-root { max-width: 700px; margin: 2rem auto 3rem; padding: 0 1.5rem; }
.chat-header { margin-bottom: 1.5rem; }
.chat-title { font-size: 1.5rem; font-weight: 600; margin: 0 0 0.25rem 0; }
.chat-subtitle { color: var(--text-muted); font-size: 0.95rem; }
.conv-list { display: flex; flex-direction: column; gap: 0.75rem; }
.conv-item {
    display: block;
    padding: 1rem 1.25rem;
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    text-decoration: none;
    color: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
}
.conv-item:hover { border-color: var(--green-200); box-shadow: var(--shadow-sm); }
.conv-item h3 { font-size: 1.1rem; margin: 0 0 0.25rem 0; }
.conv-item .meta { font-size: 0.85rem; color: var(--text-muted); }
.conv-item .status { font-size: 0.8rem; font-weight: 600; margin-top: 0.5rem; }
.conv-item .status.new { color: var(--amber-500); }
.conv-item .status.in_progress { color: #1d4ed8; }
.conv-item .status.completed { color: var(--green-600); }
.conv-item .status.cancelled { color: #6b7280; }
.empty-state { text-align: center; padding: 3rem 2rem; background: var(--green-50); border-radius: var(--radius-lg); }
.maint-pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; margin: 1.5rem 0; flex-wrap: wrap; }
.maint-pagination a, .maint-pagination span { padding: 0.4rem 0.75rem; border-radius: 8px; font-size: 0.9rem; text-decoration: none; color: var(--text-secondary); border: 1px solid var(--border); background: var(--white); }
.maint-pagination a:hover { background: var(--green-50); border-color: var(--green-200); color: var(--green-600); }
.maint-pagination .active { background: var(--green-500); color: #fff; border-color: var(--green-500); }
.maint-pagination .disabled { opacity: 0.6; cursor: not-allowed; }
.back-link { display: inline-block; margin-top: 1rem; color: var(--text-muted); text-decoration: none; }
.back-link:hover { color: var(--green-600); }
</style>
{% endblock %}

{% block content %}
<div class="chat-root">
    <div class="chat-header">
        <h1 class="chat-title">Заявки на ТО</h1>
        <p class="chat-subtitle">Выберите заявку, чтобы открыть чат с клиентом и изменить статус.</p>
    </div>

    {% if maintenance_requests %}
    <div class="conv-list">
        {% for req in maintenance_requests %}
        <a href="{% url 'chat:maintenance_thread' req.id %}" class="conv-item">
            <h3>{{ req.equipment.name }} ({{ req.equipment.model }})</h3>
            <div class="meta">
                {{ req.company.name }}
                {% if req.company.account %}{% with acc=req.company.account %}{% if acc.profile %}{{ acc.profile.first_name }} {{ acc.profile.last_name }}{% else %}{{ acc.username }}{% endif %} · {{ acc.email }}{% endwith %}{% endif %}
                · {{ req.created_at|date:"d.m.Y H:i" }}
            </div>
            {% if req.description %}<div class="meta" style="margin-top: 0.25rem;">{{ req.description|truncatewords:15 }}</div>{% endif %}
            <div class="status {{ req.status }}">
                {% if req.status == 'new' %}Новая{% endif %}
                {% if req.status == 'in_progress' %}В работе{% endif %}
                {% if req.status == 'completed' %}Выполнена{% endif %}
                {% if req.status == 'cancelled' %}Отменена{% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">Нет заявок на ТО.</div>
    {% endif %}

    {% if page_obj.paginator.num_pages > 1 %}
    <nav class="maint-pagination" aria-label="Пагинация">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}" aria-label="Предыдущая">← Назад</a>
        {% else %}
        <span class="disabled" aria-disabled="true">← Назад</span>
        {% endif %}
        {% for p in page_obj.paginator.page_range %}
        {% if p == page_obj.number %}
        <span class="active" aria-current="page">{{ p }}</span>
        {% else %}
        <a href="?page={{ p }}">{{ p }}</a>
        {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" aria-label="Следующая">Вперёд →</a>
        {% else %}
        <span class="disabled" aria-disabled="true">Вперёд →</span>
        {% endif %}
    </nav>
    {% endif %}

    <a href="{% url 'accounts:profile' %}" class="back-link">Назад в профиль</a>
</div>
{% endblock %}
