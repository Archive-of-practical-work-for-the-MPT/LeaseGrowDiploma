{% extends 'control_panel/base.html' %}
{% load control_panel_extras %}

{% block control_content %}
<div class="console-main-header">
    <div>
        <div class="console-main-title">{{ title }}</div>
        <div class="console-main-meta">Всего записей: {{ page_obj.paginator.count }}</div>
    </div>
    <div class="console-header-actions">
        <form method="get" action="" class="console-search-form">
            <input type="search" name="q" value="{{ search_q }}" placeholder="Поиск..." class="console-search-input" aria-label="Поиск">
            <button type="submit" class="btn-xs">Найти</button>
        </form>
        <div class="view-toggle" role="group" aria-label="Режим отображения">
            <button type="button" class="view-toggle-btn active" data-mode="brief" title="Кратко">Кратко</button>
            <button type="button" class="view-toggle-btn" data-mode="full" title="Полностью">Полностью</button>
        </div>
        <a href="{% url create_url %}" class="btn-xs primary">+ Добавить</a>
    </div>
</div>
<div class="console-table-wrap">
    <table class="console-table" id="list-table">
        <thead>
            <tr>
                <th class="col-id sortable">
                    <a href="?{% sort_url query_string sort_by sort_dir pk_name %}" class="sort-link">#</a>
                    <span class="sort-arrow">{% if sort_by == pk_name %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</span>
                </th>
                <th class="col-brief sortable">
                    <a href="?{% sort_url query_string sort_by sort_dir pk_name %}" class="sort-link">Объект</a>
                </th>
                {% for name, verbose in full_fields %}
                <th class="col-full col-hidden sortable">
                    <a href="?{% sort_url query_string sort_by sort_dir name %}" class="sort-link">{{ verbose }}</a>
                    <span class="sort-arrow">{% if sort_by == name %}{% if sort_dir == 'asc' %}↑{% else %}↓{% endif %}{% endif %}</span>
                </th>
                {% endfor %}
                <th class="col-actions">Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td class="col-id">{{ item.pk }}</td>
                <td class="col-brief">{{ item }}</td>
                {% for name, verbose in full_fields %}
                <td class="col-full col-hidden">{% with val=item|get_field:name %}{% if val != None %}{{ val }}{% else %}—{% endif %}{% endwith %}</td>
                {% endfor %}
                <td class="col-actions">
                    <div class="console-actions">
                        <a href="{% url edit_url_name item.pk %}" class="btn-xs">Редактировать</a>
                        <form method="post" action="{% url delete_url_name item.pk %}" style="display: inline;" onsubmit="return confirm('Удалить запись?');">
                            {% csrf_token %}
                            <button type="submit" class="btn-xs danger">Удалить</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="100" class="col-actions">
                    <div class="console-table-empty">
                        Записей пока нет. <a href="{% url create_url %}">Добавить первую</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% if page_obj.has_other_pages %}
<nav class="console-pagination" aria-label="Пагинация">
    <div class="console-pagination-inner">
        {% if page_obj.has_previous %}
        <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn-pagination" aria-label="Предыдущая">← Назад</a>
        {% else %}
        <span class="btn-pagination btn-pagination-disabled" aria-disabled="true">← Назад</span>
        {% endif %}
        <div class="console-pagination-pages">
            {% for p in page_obj.paginator.page_range %}
                {% if p == page_obj.number %}
                <span class="btn-pagination btn-pagination-active" aria-current="page">{{ p }}</span>
                {% else %}
                <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ p }}" class="btn-pagination">{{ p }}</a>
                {% endif %}
            {% endfor %}
        </div>
        {% if page_obj.has_next %}
        <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn-pagination" aria-label="Следующая">Вперёд →</a>
        {% else %}
        <span class="btn-pagination btn-pagination-disabled" aria-disabled="true">Вперёд →</span>
        {% endif %}
    </div>
</nav>
{% endif %}
<script>
(function() {
    var toggle = document.querySelector('.view-toggle');
    var table = document.getElementById('list-table');
    if (!toggle || !table) return;

    function setMode(mode) {
        var brief = table.querySelectorAll('.col-brief');
        var full = table.querySelectorAll('.col-full');
        var root = document.querySelector('.console-root');
        if (mode === 'brief') {
            brief.forEach(function(el) { el.classList.remove('col-hidden'); });
            full.forEach(function(el) { el.classList.add('col-hidden'); });
            if (root) root.classList.remove('view-mode-full');
        } else {
            brief.forEach(function(el) { el.classList.add('col-hidden'); });
            full.forEach(function(el) { el.classList.remove('col-hidden'); });
            if (root) root.classList.add('view-mode-full');
        }
        toggle.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        try { localStorage.setItem('control_panel_view_mode', mode); } catch(e) {}
    }

    var saved = localStorage.getItem('control_panel_view_mode');
    if (saved === 'full') {
        var root = document.querySelector('.console-root');
        if (root) root.classList.add('suppress-transition');
        setMode('full');
        requestAnimationFrame(function() {
            requestAnimationFrame(function() {
                if (root) root.classList.remove('suppress-transition');
            });
        });
    }

    toggle.querySelectorAll('.view-toggle-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { setMode(this.dataset.mode); });
    });
})();
</script>
{% endblock %}
