{% extends 'core/base.html' %}
{% load static %}

{% block title %}–õ–∏–∑–∏–Ω–≥ —Ç–µ—Ö–Ω–∏–∫–∏ ‚Äî LeaseGrow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'core/css/home.css' %}">
<link rel="stylesheet" href="{% static 'core/css/leasing.css' %}">
{% endblock %}

{% block content %}
<section class="leasing-hero">
    <h1>–¢–µ—Ö–Ω–∏–∫–∞ –≤ –ª–∏–∑–∏–Ω–≥</h1>
    <p>–¢—Ä–∞–∫—Ç–æ—Ä—ã, –∫–æ–º–±–∞–π–Ω—ã –∏ —Å–µ–ª—å—Ö–æ–∑—Ç–µ—Ö–Ω–∏–∫–∞ –æ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–µ–π. –û—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞—è–≤–∫—É ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —É—Å–ª–æ–≤–∏–π.</p>
</section>

<div class="leasing-section">
    <form method="get" action="{% url 'core:leasing' %}" class="leasing-filters">
        <div class="leasing-search">
            <input type="search" name="q" value="{{ search_q }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –º–æ–¥–µ–ª–∏..." class="leasing-search-input">
            <button type="submit" class="leasing-search-btn">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="leasing-filter-row">
            <label class="leasing-filter-label">
                <span>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                <select name="category" class="leasing-select">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if filter_category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="leasing-filter-label">
                <span>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</span>
                <select name="manufacturer" class="leasing-select">
                    <option value="">–í—Å–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª–∏</option>
                    {% for m in manufacturers %}
                    <option value="{{ m.id }}" {% if filter_manufacturer_id == m.id %}selected{% endif %}>{{ m.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label class="leasing-filter-label">
                <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</span>
                <select name="sort" class="leasing-select">
                    <option value="name" {% if sort == "name" %}selected{% endif %}>–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                    <option value="price" {% if sort == "price" %}selected{% endif %}>–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                    <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                    <option value="rate" {% if sort == "rate" %}selected{% endif %}>–ü–æ –ø–ª–∞—Ç–µ –≤ –º–µ—Å—è—Ü</option>
                </select>
            </label>
            <button type="submit" class="leasing-filter-apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        {% if search_q or filter_category_id or filter_manufacturer_id %}
        <a href="{% url 'core:leasing' %}" class="leasing-reset">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
        {% endif %}
    </form>

    {% if equipment_list %}
    <div class="leasing-grid">
        {% for eq in equipment_list %}
        <article class="eq-card">
            <div class="eq-card-image">üöú</div>
            <div class="eq-card-body">
                <h3 class="eq-card-title">{{ eq.name }} ‚Äî {{ eq.model }}</h3>
                <p class="eq-card-meta">{{ eq.category.name }}{% if eq.manufacturer %} ¬∑ {{ eq.manufacturer.name }}{% endif %}</p>
                {% if eq.price %}
                <div class="eq-card-price">{{ eq.price|floatformat:0 }} ‚ÇΩ</div>
                {% endif %}
                {% if eq.monthly_lease_rate %}
                <div class="eq-card-rate">–û—Ç {{ eq.monthly_lease_rate|floatformat:0 }} ‚ÇΩ/–º–µ—Å</div>
                {% endif %}
                <div class="eq-card-actions">
                    {% if current_account %}
                        {% if eq.id in pending_equipment_ids %}
                        <span class="btn-leasing sent">–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞</span>
                        {% else %}
                        <form method="post" action="{% url 'core:leasing_request_create' eq.id %}" onsubmit="return confirm('–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ {{ eq.name }}?');">
                            {% csrf_token %}
                            <input type="hidden" name="message" value="">
                            <button type="submit" class="btn-leasing">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                        </form>
                        {% endif %}
                    {% else %}
                    <a href="{% url 'accounts:login' %}?next={% url 'core:leasing' %}" class="btn-leasing guest">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É</a>
                    {% endif %}
                </div>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="leasing-empty">–°–µ–π—á–∞—Å –Ω–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∏, –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–ª—è –ª–∏–∑–∏–Ω–≥–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞.</p>
    {% endif %}

    {% if page_obj.paginator.num_pages > 1 %}
    <nav class="leasing-pagination" aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è">
        <div class="leasing-pagination-inner">
            {% if page_obj.has_previous %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="leasing-pagination-btn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è">‚Üê –ù–∞–∑–∞–¥</a>
            {% else %}
            <span class="leasing-pagination-btn disabled" aria-disabled="true">‚Üê –ù–∞–∑–∞–¥</span>
            {% endif %}
            <div class="leasing-pagination-pages">
                {% for p in page_obj.paginator.page_range %}
                    {% if p == page_obj.number %}
                    <span class="leasing-pagination-btn active" aria-current="page">{{ p }}</span>
                    {% else %}
                    <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ p }}" class="leasing-pagination-btn">{{ p }}</a>
                    {% endif %}
                {% endfor %}
            </div>
            {% if page_obj.has_next %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="leasing-pagination-btn" aria-label="–°–ª–µ–¥—É—é—â–∞—è">–í–ø–µ—Ä—ë–¥ ‚Üí</a>
            {% else %}
            <span class="leasing-pagination-btn disabled" aria-disabled="true">–í–ø–µ—Ä—ë–¥ ‚Üí</span>
            {% endif %}
        </div>
    </nav>
    {% endif %}

    {% if current_account and my_requests %}
    <section class="my-requests-section">
        <h2>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h2>
        {% for req in my_requests %}
        <div class="request-card-item">
            <div>
                <strong>{{ req.equipment.name }} ({{ req.equipment.model }})</strong>
                <span class="req-status {{ req.status }}">
                    {% if req.status == 'pending' %}–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è{% endif %}
                    {% if req.status == 'confirmed' %}–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞{% endif %}
                    {% if req.status == 'rejected' %}–û—Ç–∫–ª–æ–Ω–µ–Ω–∞{% endif %}
                </span>
            </div>
            <div>
                <a href="{% url 'chat:thread' req.id %}" class="chat-link">üí¨ –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</a>
                <span class="req-date">{{ req.created_at|date:"d.m.Y" }}</span>
            </div>
        </div>
        {% endfor %}
    </section>
    {% endif %}

    {% if not current_account %}
    <p class="leasing-login-box">–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É, <a href="{% url 'accounts:login' %}?next={% url 'core:leasing' %}">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="{% url 'accounts:register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>.</p>
    {% endif %}
</div>
{% endblock %}
